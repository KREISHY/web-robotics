{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-center align-items-center mt-5">
    <div class="card shadow-lg p-4" style="width: 400px; border-radius: 15px; border: 1px solid #ddd;">
        <h2 class="text-center mb-4">Войти в систему</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="username">Имя пользователя</label>
                <input type="text" class="form-control" id="username" placeholder="Введите имя пользователя" required>
                <div class="text-danger mt-1" id="username-error"></div>
            </div>
            <div class="form-group mt-3">
                <label for="password">Пароль</label>
                <input type="password" class="form-control" id="password" placeholder="Введите пароль" required>
                <div class="text-danger mt-1" id="password-error"></div>
            </div>
            <button type="submit" class="btn btn-primary btn-block mt-4">Войти</button>
            <p id="message" class="text-danger mt-3"></p>
        </form>
    </div>
</div>
{% endblock %}

{% block additional_scripts %}
<script>
    $(document).ready(function () {
        $('#login-form').on('submit', function (e) {
            e.preventDefault();

            // Очищаем предыдущие ошибки
            $('#username-error').text('');
            $('#password-error').text('');
            $('#message').text('');

            const username = $('#username').val();
            const password = $('#password').val();

            $.ajax({
                url: '{% url "login-username-list" %}',
                type: 'POST',
                contentType: 'application/json',
                headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                data: JSON.stringify({ username: username, password: password }),
                success: function (response) {
                    // Проверяем наличие успешного сообщения
                    if (response.message === "success") {
                        // Выполняем редирект на страницу index
                        window.location.href = "{% url 'index' %}";
                    } else {
                        // Выводим общее сообщение об ошибке
                        $('#message').text(response.message || 'Ошибка входа.');
                    }
                },
                error: function (xhr) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                
                        // Если код ошибки 403 и сообщение "Вы уже вошли в систему"
                        if (xhr.status === 403 && response.status === "authenticated") {
                            // Перенаправляем на страницу index
                            window.location.href = "{% url 'index' %}";
                        }
                
                        // Выводим ошибки в соответствующих полях, если они есть
                        if (response.username) {
                            $('#username-error').text(response.username[0]);
                        }
                        if (response.password) {
                            $('#password-error').text(response.password[0]);
                        }
                    } catch (e) {
                        // Общая ошибка при парсинге
                        $('#message').text('Ошибка сервера. Попробуйте позже.');
                    }
                }
            });
        });
    });
</script>
{% endblock %}
